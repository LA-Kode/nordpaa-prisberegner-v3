(function(){'use strict';
const cfg=(window.npPBv3||{}).config||{},ajax=(window.npPBv3||{}).ajax,nonce=(window.npPBv3||{}).nonce;
const h=(t,a={},c=[])=>{const e=document.createElement(t);for(const k in a){if(k==='class')e.className=a[k];else if(k.startsWith('on')&&typeof a[k]==='function')e.addEventListener(k.substring(2),a[k]);else e.setAttribute(k,a[k]);}if(!Array.isArray(c))c=[c];c.forEach(x=>x!=null&&e.appendChild(typeof x==='string'?document.createTextNode(x):x));return e};
const cur=n=>{try{return new Intl.NumberFormat('da-DK',{style:'currency',currency:'DKK',maximumFractionDigits:0}).format(n)}catch(e){return Math.round(n)+' kr.'}};
function render(){const root=document.getElementById('np3-calc');if(!root)return;
const s={bandIndex:2,billing:'yearly',discount:cfg.yearly_discount||0,bands:cfg.bands||[],items:(cfg.modules||[]).map(m=>Object.assign({checked:false},m)),lead:{name:'',email:'',phone:'',company:(cfg.branding&&cfg.branding.company)||''}};
root.innerHTML='';root.appendChild(header());root.appendChild(slider());root.appendChild(billing());root.appendChild(products());root.appendChild(summary());root.appendChild(lead());updateTotals();
function header(){return h('div',{class:'np3-header'},[h('div',{class:'np3-topbtns'},[h('a',{href:(ajax||'#').replace('admin-ajax.php','admin.php?page=np-pb-v3-leads'),class:'np3-chip'},'Leads'),h('a',{href:(ajax||'#').replace('admin-ajax.php','admin.php?page=np-pb-v3'),class:'np3-chip'},'Administrator')]),h('h1',{class:'np3-title'},'Prisberegner'),h('div',{class:'np3-sub'},'Skræddersy din løsning og se prisen med det samme')]);}
function slider(){const w=h('div',{class:'np3-card'}),head=h('div',{class:'np3-row-between'},[h('div',{class:'np3-h6'},'Antal ansatte'),h('div',{class:'np3-badge'},s.bands[s.bandIndex]?.label||'')]);const r=h('input',{type:'range',min:0,max:Math.max(0,s.bands.length-1),value:s.bandIndex,class:'np3-range',oninput:e=>{s.bandIndex=parseInt(e.target.value,10);head.lastChild.textContent=s.bands[s.bandIndex]?.label||'';updatePrices();updateTotals();}});const ticks=h('div',{class:'np3-ticks'},s.bands.map((b,i)=>h('span',{class:'np3-tick'+(i===s.bandIndex?' active':''),'data-i':i},b.label)));r.addEventListener('input',()=>Array.from(ticks.children).forEach((t,i)=>t.classList.toggle('active',i===s.bandIndex)));[head,r,ticks].forEach(x=>w.appendChild(x));return w;}
function billing(){const w=h('div',{class:'np3-card'},[h('div',{class:'np3-billing'},[pill('Månedlig','monthly',s.billing==='monthly'),pill('Årlig','yearly',s.billing==='yearly',s.discount?('-'+s.discount+'%'):'')])]);return w;function pill(l,v,a,b){return h('button',{class:'np3-pill'+(a?' active':''),onclick:()=>{s.billing=v;Array.from(event.currentTarget.parentNode.children).forEach(c=>c.classList.remove('active'));event.currentTarget.classList.add('active');updateTotals();updatePrices();}},[l,b?h('span',{class:'np3-pill-badge'},b):null]);}}
function products(){const g=h('div',{class:'np3-grid'});s.items.forEach(it=>{const chk=h('input',{type:'checkbox',onclick:e=>{it.checked=e.target.checked;updateTotals();}});const price=h('div',{class:'np3-price'});it._priceEl=price;const card=h('label',{class:'np3-mod-card'},[h('div',{class:'np3-mod-left'},[h('div',{class:'np3-checkwrap'},[chk]),h('div',{class:'np3-mod-info'},[h('div',{class:'np3-mod-title'},it.name||'Modul'),h('div',{class:'np3-mod-desc'},it.desc||'')])]),h('div',{class:'np3-mod-right'},[price,h('div',{class:'np3-mod-unit'},s.billing==='yearly'?' / år':' / md.')])]);g.appendChild(card);});return h('div',{class:'np3-card'},[h('div',{class:'np3-h6'},'Vælg moduler'),g]);}
function summary(){const w=h('div',{class:'np3-card'}),list=h('div',{class:'np3-summary-list'}),disc=h('div',{class:'np3-summary-row discount'},['Årlig rabat ('+s.discount+'%)',h('span',{},'')]),total=h('div',{class:'np3-total'},['Total',h('div',{class:'np3-total-right'},[h('span',{class:'np3-total-amt'}),h('span',{class:'np3-total-unit'},'per år')])]),pdf=h('div',{class:'np3-pdfrow'},[h('button',{class:'np3-btn-ghost',onclick:pdfDl},'🧾 Download Tilbud som PDF')]);[h('div',{class:'np3-h6'},'Opsummering'),list,disc,total,pdf].forEach(x=>w.appendChild(x));s._summary={list,disc,totalAmt:total.querySelector('.np3-total-amt'),totalUnit:total.querySelector('.np3-total-unit')};return w;}
function lead(){const w=h('div',{class:'np3-card np3-lead'});w.appendChild(h('h2',{class:'np3-lead-title'},'Kom i gang i dag'));w.appendChild(h('div',{class:'np3-lead-sub'},'Udfyld formularen, så kontakter vi dig hurtigst muligt'));const f=h('div',{class:'np3-form'});const F=(L,ph,k)=>{const r=h('div',{class:'np3-field'});r.appendChild(h('label',{},L));const i=h('input',{type:'text',placeholder:ph});i.addEventListener('input',e=>s.lead[k]=e.target.value);r.appendChild(i);return r};[F('Navn','Dit fulde navn','name'),F('E-mail','din@email.dk','email'),F('Telefon','+45 12 34 56 78','phone'),h('div',{class:'np3-lead-actions'},[h('button',{class:'np3-btn-primary',onclick:()=>leadSend('callback')},'Jeg vil gerne ringes op'),h('button',{class:'np3-btn-ghost',onclick:()=>leadSend('research')},'Jeg undersøger markedet')])].forEach(x=>f.appendChild(x));w.appendChild(f);return w;}
function updatePrices(){s.items.forEach(it=>{const p=(it.prices||[])[s.bandIndex]||0;const v=s.billing==='yearly'?(p*12*(1-(s.discount||0)/100)):p;if(it._priceEl) it._priceEl.textContent=cur(Math.round(v));});}
function updateTotals(){const monthly=s.items.reduce((a,it)=>it.checked?a+((it.prices||[])[s.bandIndex]||0):a,0);let yearly=monthly*12,disc=0;if(s.billing==='yearly'&&s.discount){disc=yearly*(s.discount/100);yearly-=disc;}const S=s._summary;S.list.innerHTML='';s.items.filter(i=>i.checked).forEach(i=>{const p=(i.prices||[])[s.bandIndex]||0;const v=s.billing==='yearly'?(p*12*(1-(s.discount||0)/100)):p;S.list.appendChild(h('div',{class:'np3-summary-row'},[i.name,h('span',{},cur(Math.round(v)))]));});S.disc.style.display=(s.billing==='yearly'&&s.discount)?'grid':'none';S.disc.lastChild.textContent='-'+cur(Math.round(disc));if(s.billing==='yearly'){S.totalAmt.textContent=cur(Math.round(yearly));S.totalUnit.textContent='per år';s._currentTotal=Math.round(yearly);}else{S.totalAmt.textContent=cur(Math.round(monthly));S.totalUnit.textContent='per md.';s._currentTotal=Math.round(monthly);}updatePrices();}
async function pdfDl(){const items=s.items.filter(i=>i.checked).map(i=>{const p=(i.prices||[])[s.bandIndex]||0;const v=s.billing==='yearly'?(p*12*(1-(s.discount||0)/100)):p;return {name:i.name,price:Math.round(v),price_text:cur(Math.round(v))};});const payload={company:s.lead.company,band_label:s.bands[s.bandIndex]?.label||'',billing:s.billing,items,total:s._currentTotal,total_text:cur(s._currentTotal)};const fd=new FormData();fd.append('action','np_pb_v3_generate_pdf');fd.append('nonce',nonce);fd.append('payload',JSON.stringify(payload));const res=await fetch(ajax,{method:'POST',body:fd});const data=await res.json();if(data&&data.success&&data.data.url){window.location.href=data.data.url}else alert('Kunne ikke generere PDF.');}
async function leadSend(type){const fd=new FormData();fd.append('action','np_pb_v3_submit_lead');fd.append('nonce',nonce);fd.append('name',s.lead.name||'');fd.append('email',s.lead.email||'');fd.append('phone',s.lead.phone||'');fd.append('company',s.lead.company||'');fd.append('price',cur(s._currentTotal));fd.append('lead_type',type);const res=await fetch(ajax,{method:'POST',body:fd});const data=await res.json();alert((data&&data.success)?'Tak! Vi kontakter dig.':'Noget gik galt.');}
}
if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',render);else render();
})();